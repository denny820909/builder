'''
Created on Dec 26, 2012

__author__ = "Elizabeth 'pidge' Flanagan"
__copyright__ = "Copyright 2013, Intel Corp."
__credits__ = ["Elizabeth Flanagan"]
__license__ = "GPL"
__version__ = "2.0"
__maintainer__ = "Elizabeth Flanagan"
__email__ = "elizabeth.flanagan@intel.com"
'''

from buildbot.steps.shell import ShellCommand
from twisted.python import log
from autobuilder.config import *
import os

class CreateAutoConf(ShellCommand):
    haltOnFailure = False 
    flunkOnFailure = True 
    name = "Create Auto Configuration" 
    def __init__(self, factory, argdict=None, **kwargs):
        self.machine=""
        self.buildapp=""
        self.distro="poky"
        self.buildhistory=False
        self.gplv3=True
        self.multilib=False
        self.swabber=False
        self.x32=False
        self.atext=""
        self.emgd=False
        self.pvr=False
        self.atextprepend=""
        self.atextappend=""
        self.SDKMACHINE="i686"
        self.adtdev=False
        self.factory = factory
        self.buildappsrcrev = "${AUTOREV}"
        self.slaveworkdir=os.path.join(os.path.join(YOCTO_ABBASE, "yocto-slave"))

        for k, v in argdict.iteritems():
            if type(v) is bool:
                setattr(self, k, str(v))
            else:
                setattr(self, k, v)
        self.description = "Create Auto Configuration"
        ShellCommand.__init__(self, **kwargs)

    def start(self):
        buildername=self.getProperty("buildername")
        try:
            distroversion=self.getProperty("distroversion")
        except:
            pass
        fout = ""
        #check to see if we have a prepend

        if self.atextprepend is not "":
            fout = fout + self.atextprepend
        #check to see if we have text override
        if self.atext is not "":
            fout = fout+self.atext
        else:
            fout = 'MACHINE = "' + self.machine + '"\n'
            fout = 'PACKAGE_CLASSES = "package_rpm package_deb package_ipk"\n'
            fout = fout + 'BB_NUMBER_THREADS = "' + os.environ.get('BB_NUMBER_THREADS') + '"\n'
            fout = fout + 'PARALLEL_MAKE = "-j ' + os.environ.get('PARALLEL_MAKE') + '"\n'
            fout = fout + 'SDKMACHINE ?= "' + self.SDKMACHINE + '"\n'
            buildprops = self.getProperties().asDict()
            for k, v in buildprops.iteritems():
                if "buildappsrcrev" in k:
                    self.buildappsrcrev=v[0]
            if self.buildapp == "True":
                if self.buildappsrcrev == "AUTOREV":
                    self.buildappsrcrev="${AUTOREV}"
                fout = fout + 'DL_DIR ?= "${TOPDIR}/downloads"\n'
                fout = fout + 'INHERIT += "own-mirrors"\n'
                fout = fout + 'SOURCE_MIRROR_URL = "file:///' + os.environ.get('SOURCE_DL_DIR') +'"\n'
                if self.buildappsrcrev != "DEFAULT":
                    fout = fout + 'SRCREV_pn-build-appliance-image = "' + self.buildappsrcrev + '"\n'
            else:
                fout = fout + 'DL_DIR = "' + os.environ.get('SOURCE_DL_DIR')+'"\n'
            if self.emgd == "True":
                fout = fout + 'LICENSE_FLAGS_WHITELIST = "license_emgd-driver-bin" \n'
            if self.pvr == "True":
                fout = fout + 'LICENSE_FLAGS_WHITELIST += "license_cdv-pvr-driver" \n'
                fout = fout + 'PVR_LICENSE = "yes" \n'
            if self.multilib == "True":
                fout = fout + 'require conf/multilib.conf \n'
                fout = fout + 'MULTILIBS = "multilib:lib32" \n'
                fout = fout + 'DEFAULTTUNE_virtclass-multilib-lib32 = "x86" \n'
                fout = fout + 'SSTATE_DIR ?= "' + os.environ.get("SSTATE_PUBLISH_DIR") + '/multilib" \n'
            else:
                fout = fout + 'SSTATE_DIR ?= "' + os.environ.get("SSTATE_PUBLISH_DIR") + '/" \n'
            try:
                if self.gplv3 == "False":
                    fout = fout + 'INCOMPATIBLE_LICENSE = "GPLv3" \n'
            except:
                pass
            if self.x32 == "True":
                    fout = fout + 'DEFAULTTUNE = "x86-64-x32"'
                    fout = fout + 'baselib = "${@d.getVar(\'BASE_LIB_tune-\' + (d.getVar(\'DEFAULTTUNE\', True) or \'INVALID\'), True) or \'lib\'} \n"
            if self.distro == "poky-rt":
                fout = fout + 'PREFERRED_PROVIDER_virtual/kernel="linux-yocto-rt" \n'
            fout = fout + 'MACHINE = "' + self.machine + '"\n'
            fout = fout + 'PREMIRRORS = ""\n'
            try:
                if self.swabber == "True":
                    fout = fout + 'USER_CLASSES += "image-prelink image-swab"\n'
            except:
                pass
            if os.environ.get("PUBLISH_SOURCE_MIRROR") == "True":
                fout = fout + 'BB_GENERATE_MIRROR_TARBALLS = "1"\n'
            try:
                if self.buildhistory == True and os.environ.get("BUILD_HISTORY_COLLECT") == "True" and self.getProperty("branch") == "master":
                    fout = fout + 'INHERIT += "buildhistory"\n'
                    fout = fout + 'BUILDHISTORY_COMMIT = "1"\n'
                    fout = fout + 'BUILDHISTORY_DIR = "' + os.environ.get('BUILD_HISTORY_DIR') + '/' + self.getProperty("buildername") + '/poky-buildhistory"\n'
                    fout = fout + 'BUILDHISTORY_PUSH_REPO = "' + os.environ.get('BUILD_HISTORY_REPO') + ' ' + self.getProperty("buildername") + ':' + self.getProperty("buildername") + '"\n'
            except:
                pass
            try:
                revision=self.getProperty("got_revision_poky")
            except:
                pass
            if revision and self.getProperty("distroversion"):
                if self.adtdev == "True":
                    adtrepo_url=os.environ.get("ADTREPO_DEV_URL")
                    fout=fout+'ADTREPO = "' + adtrepo_url + '/' + self.getProperty("distroversion") + '-' + revision + '/ \n'
        if self.atextappend is not "":
            fout = fout + self.atextappend
        self.command = "rm -rf ./build/conf/auto.conf; echo '" +  fout + "'>> ./build/conf/auto.conf"
        ShellCommand.start(self)

    def describe(self, done=False):
        description = ShellCommand.describe(self,done)
        return description


